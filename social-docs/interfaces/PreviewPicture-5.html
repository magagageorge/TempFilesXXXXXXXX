<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>woorbi documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">woorbi documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>PreviewPicture</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/messages/widgets/chat-thread-widget/chat-thread-widget.component.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#file">file</a>
                                </li>
                                <li>
                                        <a href="#height">height</a>
                                </li>
                                <li>
                                        <a href="#url">url</a>
                                </li>
                                <li>
                                        <a href="#width">width</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="file"></a>
                                        <span class="name"><b>file</b><a href="#file"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>file:     <code>File</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>File</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="height"></a>
                                        <span class="name"><b>height</b><a href="#height"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>height:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="url"></a>
                                        <span class="name"><b>url</b><a href="#url"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>url:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="width"></a>
                                        <span class="name"><b>width</b><a href="#width"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>width:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnInit, Input, ViewChild, ElementRef, AfterViewInit, HostListener, EventEmitter } from &#x27;@angular/core&#x27;;
import { MessengerService } from &#x27;@app/messages/services/messenger.service&#x27;;
import { ChatRoom } from &#x27;@app/messages/models/chat-room&#x27;;
import { Observable, of, fromEvent, Subscription } from &#x27;rxjs&#x27;;
import { Message } from &#x27;@app/messages/models/message&#x27;;
import { Router } from &#x27;@angular/router&#x27;;
import { Profile } from &#x27;@app/models/profile/profile&#x27;;
import { MessageForm } from &#x27;@app/messages/models/message-form&#x27;;
import { MathService } from &#x27;@app/services/math.service&#x27;;
import { debounceTime, distinctUntilChanged, map } from &#x27;rxjs/operators&#x27;;
import { Link, WfLinkifyService } from &#x27;@app/libs/wf-linkify&#x27;;
import { WfLinkPreviewService } from &#x27;@app/libs/wf-link-preview/services/wf-link-preview.service&#x27;;
import { LinkPreview } from &#x27;@app/libs/wf-link-preview&#x27;;
import { SysFunctions } from &#x27;@app/libs/utilities/common-functions&#x27;;
import { NgxImageCompressService } from &#x27;ngx-image-compress&#x27;;


export interface PreviewPicture {
  url: string;
  width: number;
  height: number;
  file: File;
}

export interface PreviewFile {
  name: string;
  size: string;
  extention: string;
  file: File;
}


@Component({
  selector: &#x27;app-chat-thread-widget&#x27;,
  templateUrl: &#x27;./chat-thread-widget.component.html&#x27;,
  styleUrls: [&#x27;./chat-thread-widget.component.scss&#x27;]
})
export class ChatThreadWidgetComponent implements AfterViewInit {

  @Input() chatroom: ChatRoom;
  @ViewChild(&quot;messagesContainer&quot;, { static: false })
  messagesContainer: ElementRef;
  @ViewChild(&quot;messageInput&quot;, { static: false })
  messageInput: ElementRef;
  messengerService: MessengerService;
  reached_end_of_messages: boolean &#x3D; false;
  loading_messages: boolean;
  next_messages_page: number;
  messageInputHeight: number &#x3D; 0;
  messageInputWidth: number &#x3D; 0;
  messagesBoxWidth: number &#x3D; 0;
  maxMessageImageWidth: number &#x3D; 0;
  errors: any[];
  messages: any[];
  router: Router;
  submitted: boolean &#x3D; false;
  link_preview_info: any;
  pushing_message: boolean &#x3D; false;
  recipients: any[] &#x3D; [];
  filesToUpload: Array&lt;File&gt; &#x3D; [];
  image_preview_urls: PreviewPicture[] &#x3D; [];
  file_preview_list: PreviewFile[] &#x3D; [];
  allowedExtensions: string[] &#x3D; [&#x27;doc&#x27;, &#x27;docx&#x27;, &#x27;csv&#x27;, &#x27;xls&#x27;, &#x27;xlsx&#x27;, &#x27;pdf&#x27;, &#x27;txt&#x27;, &#x27;png&#x27;, &#x27;jpg&#x27;, &#x27;gif&#x27;, &#x27;jpeg&#x27;];
  extentionIcons: any &#x3D; { &#x27;doc&#x27;: &#x27;fa fa-file-word-o&#x27;, &#x27;docx&#x27;: &#x27;fa fa-file-word-o&#x27;, &#x27;pdf&#x27;: &#x27;fa fa-file-pdf-o&#x27;, &#x27;csv&#x27;: &#x27;fa fa-file-o&#x27;, &#x27;xls&#x27;: &#x27;fa fa-file-excel-o&#x27;, &#x27;xlsx&#x27;: &#x27;fa fa-file-excel-o&#x27;, &#x27;txt&#x27;: &#x27;fa fa-file-text-o&#x27; };

  onLinkFound: EventEmitter&lt;Array&lt;Link&gt;&gt; &#x3D; new EventEmitter&lt;Array&lt;Link&gt;&gt;();

  links: Link[] &#x3D; [];
  mentions: Link[] &#x3D; [];
  hashtags: Link[] &#x3D; [];
  linkPreview: LinkPreview &#x3D; null;

  constructor(messengerService: MessengerService, public imageCompress: NgxImageCompressService, public linkifyService: WfLinkifyService,
    public linkPreviewService: WfLinkPreviewService, router: Router) {
    this.messengerService &#x3D; messengerService;
    this.router &#x3D; router;
  }

  ngAfterViewInit() {
    setTimeout(() &#x3D;&gt; {
      this.getDimensions();
    }, 0);
    this._init();
    this.next_messages_page &#x3D; 2;
  }

  getDimensions() {
    this.messagesBoxWidth &#x3D; this.messageInputWidth &#x3D; this.messageInput.nativeElement.clientWidth;
    this.maxMessageImageWidth &#x3D; Math.round(this.messagesBoxWidth * 0.83);
    this.messageInputHeight &#x3D; this.messageInput.nativeElement.clientHeight;
  }

  scrollMessagesToBottom() {
    try {
      this.messagesContainer.nativeElement.scrollTop &#x3D; this.messagesContainer.nativeElement.scrollHeight;
    } catch (e) {
      console.error(e);
    }
  }

  messageFocus() {
    if (this.chatroom.form.message.trim() &#x3D;&#x3D; &#x27;&#x27;) {
      this.chatroom.form.message &#x3D; &quot; &quot;;
    }
  }

  OnBlurMessageBox() {
    if (this.chatroom.form.message.trim() &#x3D;&#x3D; &#x27;&#x27;) {
      this.chatroom.form.message &#x3D; &#x27;&#x27;;
    }
  }

  pushMessage() {
    var _this &#x3D; this;
    this.errors &#x3D; this.messages &#x3D; [];
    const formData: any &#x3D; new FormData();
    const files: Array&lt;File&gt; &#x3D; this.filesToUpload;

    if (this.chatroom.isNew &amp;&amp; this.chatroom.profiles.length &lt; 1) {
      return;
    }

    this.messengerService.service.getProvider(this.messengerService.provider).crudconfig.route_url &#x3D; &#x27;ms/chat/&#x27;;
    if (this.chatroom.form.message &#x3D;&#x3D; &#x27;&#x27; &amp;&amp; files.length &lt; 1 &amp;&amp; this.image_preview_urls.length &lt; 1) {
      return false;
    }

    if (files &amp;&amp; files.length &gt; 0) {
      for (let i &#x3D; 0; i &lt; files.length; i++) {
        formData.append(&quot;ChatMessageForm[upload_files][]&quot;, files[i], files[i][&#x27;name&#x27;]);
      }
    }

    if (this.linkPreview !&#x3D;&#x3D; null) {
      this.linkPreview.code &#x3D; &quot;&quot;;
      formData.append(&quot;link&quot;, JSON.stringify(this.linkPreview));
    }

    formData.append(&quot;roomId&quot;, this.chatroom.id);
    formData.append(&quot;isNewCR&quot;, this.chatroom.isNew);
    if (this.chatroom.isNew &amp;&amp; this.chatroom.profiles.length) {
      this.recipients &#x3D; [];
      this.chatroom.profiles.forEach((p: Profile) &#x3D;&gt; {
        this.recipients.push({ id: p.user_id });
      });
    }
    formData.append(&quot;profiles&quot;, JSON.stringify(this.recipients));
    formData.append(&quot;message&quot;, this.chatroom.form.message.trim());
    if (this.submitted &#x3D;&#x3D;&#x3D; false) {
      this.pushing_message &#x3D; true;
      this.submitted &#x3D; true;
      this.messengerService.service.create(this.messengerService.provider, formData, {}).subscribe(function (result) {
        _this.submitted &#x3D; false;
        if (result.isSuccess()) {
          _this.messages &#x3D; result.getMessages();
          var data &#x3D; result.getResultData();
          var data_chatroom &#x3D; data.chatroom as ChatRoom;
          var data_message &#x3D; data.message;
          if (data.done &#x3D;&#x3D; true) {
            //_this.messengerService.service.prependFeed(data.data);
            _this.filesToUpload &#x3D; [];
            _this.image_preview_urls &#x3D; [];
            if (_this.chatroom.isNew &amp;&amp; data_chatroom !&#x3D; null) {
              data_chatroom.form &#x3D; new MessageForm();
              if (_this.router.url &#x3D;&#x3D; &#x27;/messages/thread/new&#x27;) {
                _this.messengerService.CURRENT_MESSENGER_CHATROOM &#x3D; data_chatroom;
                return _this.router.navigateByUrl(&#x27;messages/thread/&#x27; + data_chatroom.id + &#x27;&#x27;);
              }
              _this.chatroom &#x3D; data_chatroom;
            }
            if (data_message !&#x3D; null) {
              _this.chatroom.messages.push(data_message);
              _this.scrollMessagesToBottom();
            }
          }
        } else {
          _this.errors &#x3D; result.getErrors();
        }
        _this.pushing_message &#x3D; false;
      });
      _this.filesToUpload &#x3D; [];
      _this.image_preview_urls &#x3D; [];
      _this.file_preview_list &#x3D; [];
      this.clearMessageForm();
    }
  }

  clearMessageForm() {
    this.chatroom.form &#x3D; new MessageForm();
  }

  onScrollUp() {
    this.loadThreadMessages({ room: this.chatroom.id, page: this.next_messages_page });
  }

  loadThreadMessages(params?: {}): any {
    var _this &#x3D; this;
    if (this.reached_end_of_messages) {
      return;
    }
    var next_page: boolean &#x3D; false;
    var end_ofthread: boolean &#x3D; true;
    this.loading_messages &#x3D; true;
    this.messengerService.service.getProvider(this.messengerService.provider).crudconfig.route_url &#x3D; &#x27;ms/chat/&#x27;;
    return this.messengerService.service.getall(this.messengerService.provider, params).subscribe(results &#x3D;&gt; {
      _this.loading_messages &#x3D; false;
      if (results.isSuccess()) {
        var messages &#x3D; results.getResultData() as Message[];
        if (messages.length &gt; 0) {
          messages.forEach((message: Message) &#x3D;&gt; {
            _this.searchMessage(message.id).subscribe((m: Message) &#x3D;&gt; {
              if (m) { }
              else {
                _this.chatroom.messages.unshift(message);
                next_page &#x3D; true;
                end_ofthread &#x3D; false;
              }
            });
          });

          if (end_ofthread) {
            _this.reached_end_of_messages &#x3D; true;
          }

          if (next_page) {
            _this.next_messages_page++;
          }

        } else {
          _this.reached_end_of_messages &#x3D; true;
        }
      }
    });
  }

  searchMessage(id: number): Observable&lt;Message&gt; {
    return of(this.chatroom.messages.find((message: Message) &#x3D;&gt; message.id &#x3D;&#x3D; id));
  }

  onSelectFile(event) {
    if (event.target.files &amp;&amp; event.target.files[0]) {
      //this.filesToUpload &#x3D; this.filesToUpload.concat(&lt;Array&lt;File&gt;&gt;event.target.files);
      var filesAmount &#x3D; event.target.files.length;
      let files &#x3D; event.target.files;
      for (let i &#x3D; 0; i &lt; filesAmount; i++) {
        var f &#x3D; files[i];
        if (this.validateFile(f)) {
          // Process Valid Files.
          if (f.type.match(&#x27;image.*&#x27;)) {
            this.PushPreviewImages(&lt;File&gt;f);
          } else {
            this.file_preview_list.push({ name: f.name, size: MathService.BitesToSize(f.size), extention: MessengerService.getFileExtension(f.name), file: f });
            this.filesToUpload.push(&lt;File&gt;f);
          }
        } else {
          continue;
        }
      }
    }
  }

  PushPreviewImages(f: File) {
    var fileReader &#x3D; new FileReader();
    var i_url;
    var _this &#x3D; this;
    fileReader.onload &#x3D; (e) &#x3D;&gt; {
      if (e) {
        i_url &#x3D; (&lt;FileReader&gt;e.target).result;
        SysFunctions.getImageCompressionRates(i_url, &#x27;MESSAGE_IMAGE&#x27;).then(rts &#x3D;&gt; {
          SysFunctions.getImageOrientation(f).then(orientation &#x3D;&gt; {
            _this.imageCompress.compressFile(i_url, orientation, rts.ratio, rts.quality).then(
              processedImageDataUrl &#x3D;&gt; {
                var loadedImage &#x3D; new Image();
                loadedImage.onload &#x3D; (event) &#x3D;&gt; {
                  if (event) {
                    console.log(rts)
                    var imgFile &#x3D; SysFunctions.DataUrlToFile(processedImageDataUrl);
                    _this.filesToUpload.push(imgFile);
                    _this.image_preview_urls.push({ url: processedImageDataUrl, width: loadedImage.width, height: loadedImage.height, file: imgFile });
                  }
                }
                loadedImage.src &#x3D; processedImageDataUrl;
              });
          });

        });
      }
    }
    fileReader.readAsDataURL(&lt;File&gt;f);
  }

  RemovePreviewImage(preview: PreviewPicture) {
    this.image_preview_urls &#x3D; this.image_preview_urls.filter((x: PreviewPicture) &#x3D;&gt; x.url !&#x3D;&#x3D; preview.url);
    if (preview.file !&#x3D;&#x3D; null) {
      this.filesToUpload &#x3D; this.filesToUpload.filter((x: File) &#x3D;&gt; x !&#x3D;&#x3D; &lt;File&gt;preview.file);
    }
  }

  RemoveFilePreview(file_preview: PreviewFile) {
    this.file_preview_list &#x3D; this.file_preview_list.filter((x: PreviewFile) &#x3D;&gt; x.file !&#x3D;&#x3D; file_preview.file);
    if (file_preview.file !&#x3D;&#x3D; null) {
      this.filesToUpload &#x3D; this.filesToUpload.filter((x: File) &#x3D;&gt; x !&#x3D;&#x3D; &lt;File&gt;(file_preview.file));
    }
  }

  SelectUploadAttachment(): void {
    var elem: HTMLElement &#x3D; document.querySelector(&#x27;#message_upload_input_id&#x27;);
    if (elem !&#x3D; null) {
      elem.click();
    }
  }

  validateFile(file: File): Boolean {
    if (this.allowedExtensions.length !&#x3D;&#x3D; 0 &amp;&amp; file instanceof File) {
      const ext &#x3D; MessengerService.getFileExtension(file.name);
      if (this.allowedExtensions.indexOf(ext) !&#x3D;&#x3D; -1) {
        return true;
      }
    }
    return false;
  }

  @HostListener(&#x27;window:resize&#x27;, [&#x27;$event&#x27;])
  onResize(event) {
    this.getDimensions();
  }

  private _init() {
    fromEvent(document, &#x27;input&#x27;)
      .pipe(
        debounceTime(2000),
        distinctUntilChanged(),
        map(event &#x3D;&gt; {
          const data &#x3D; event.target[&#x27;innerHTML&#x27;];
          const links: Link[] &#x3D; this.linkifyService.find(data);
          //console.log(&#x27;data: &#x27;, data);
          //console.log(&#x27;links: &#x27;, links);
          //event.target[&#x27;innerHTML&#x27;] &#x3D; this.linkifyService.linkify(data);
          return links;
        })).subscribe((links) &#x3D;&gt; {
          this.onLinkFound.emit(links);
        });

    this.onLinkFound.subscribe((links: Array&lt;Link&gt;) &#x3D;&gt; {
      this.links &#x3D; [];
      links.forEach(link &#x3D;&gt; {
        if (link.type &#x3D;&#x3D; &#x27;url&#x27;) {
          this.linkPreviewService.searchLink(this.links, link.value).subscribe(lin &#x3D;&gt; {
            if (!lin) {
              this.links.push(link);
            }
          });
        }
        if (link.type &#x3D;&#x3D; &#x27;mention&#x27;) {
          this.linkPreviewService.searchLink(this.mentions, link.value).subscribe(lin &#x3D;&gt; {
            if (!lin) {
              this.mentions.push(link);
            }
          });
        }
        if (link.type &#x3D;&#x3D; &#x27;hashtag&#x27;) {
          this.linkPreviewService.searchLink(this.hashtags, link.value).subscribe(lin &#x3D;&gt; {
            if (!lin) {
              this.hashtags.push(link);
            }
          });
        }
      });
    });

  }

  updateLinkPreview(prev: LinkPreview) {
    this.linkPreview &#x3D; prev;
  }

}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'PreviewPicture-5.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
